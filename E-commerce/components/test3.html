<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cart Page - Bootstrap Only</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-white">

<div id="headerNew-placeholder" class="sticky-top"></div>

<div class="container mt-4">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#" class="text-muted text-decoration-none">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Cart</li>
    </ol>
  </nav>

  <!-- Products Table -->
  <div class="table-responsive mb-4">
    <table class="table align-middle" id="cart-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody id="cart-body">
        <!-- Dynamic cart items will be inserted here -->
      </tbody>
    </table>
  </div>

  <!-- Action Buttons -->
  <div class="d-flex justify-content-between mb-4">
    <button class="btn btn-outline-dark">Return To Shop</button>
    <button class="btn btn-outline-dark" id="update-cart">Update Cart</button>
  </div>

  <!-- Coupon + Cart Total side by side -->
  <div class="row align-items-start">
    <!-- Coupon Code -->
    <div class="col-md-6 mb-3 mb-md-0">
      <div class="input-group">
        <input type="text" class="form-control" id="coupon-code" placeholder="Coupon Code" aria-label="Coupon Code">
        <button class="btn btn-danger" id="apply-coupon">Apply Coupon</button>
      </div>
    </div>
    <!-- Cart Total Box -->
    <div class="col-md-6">
      <div class="border rounded p-4" id="cart-total-box">
        <h5 class="fw-semibold mb-3">Cart Total</h5>
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal:</span>
          <span id="subtotal">$0</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Shipping:</span>
          <span id="shipping">Free</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between mb-3">
          <span>Total:</span>
          <span id="total">$0</span>
        </div>
        <button class="btn btn-danger w-100">Process to checkout</button>
      </div>
    </div>
  </div>
</div>

<div id="footer-placeholder"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Header fetch
  document.addEventListener("DOMContentLoaded", function () {
      fetch('headerNew.html')
          .then(response => {
              if (!response.ok) throw new Error(`Failed to fetch headerNew.html: ${response.statusText}`);
              return response.text();
          })
          .then(data => {
              document.getElementById('headerNew-placeholder').innerHTML = data;
              updateBadges();
          })
          .catch(error => console.error('Error fetching header:', error.message));
  });

  // Footer fetch
  document.addEventListener("DOMContentLoaded", function () {
      fetch('footer.html')
          .then(response => {
              if (!response.ok) throw new Error(`Failed to fetch footer.html: ${response.statusText}`);
              return response.text();
          })
          .then(data => {
              document.getElementById('footer-placeholder').innerHTML = data;
          })
          .catch(error => console.error('Error fetching footer:', error.message));
  });

  // Function to update badges in header
  function updateBadges() {
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');

      const heartLink = document.querySelector('.nav-link .bi-heart').parentNode;
      let favoriteBadge = heartLink.querySelector('.badge');
      if (!favoriteBadge) {
          favoriteBadge = document.createElement('span');
          favoriteBadge.className = 'badge bg-danger rounded-pill position-absolute';
          favoriteBadge.style = 'top: -5px; right: -5px;';
          heartLink.appendChild(favoriteBadge);
      }
      favoriteBadge.innerText = favorites.length > 0 ? favorites.length : '';

      const cartLink = document.querySelector('.nav-link .bi-cart3').parentNode;
      let cartBadge = cartLink.querySelector('.badge');
      if (!cartBadge) {
          cartBadge = document.createElement('span');
          cartBadge.className = 'badge bg-danger rounded-pill position-absolute';
          cartBadge.style = 'top: -5px; right: -5px;';
          cartLink.appendChild(cartBadge);
      }
      cartBadge.innerText = cart.length > 0 ? cart.length : '';
  }

  // Fetch JSON data and populate products
  function loadProducts() {
      return new Promise((resolve, reject) => {
          const storedProducts = localStorage.getItem('products');
          if (storedProducts) {
              resolve(JSON.parse(storedProducts));
          } else {
              fetch('products.json')
                  .then(response => {
                      if (!response.ok) throw new Error(`Failed to fetch products.json: ${response.statusText}`);
                      return response.json();
                  })
                  .then(data => {
                      localStorage.setItem('products', JSON.stringify(data));
                      resolve(data);
                  })
                  .catch(error => reject(error));
          }
      });
  }

  function updateCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      loadProducts().then(products => {
          const cartBody = document.getElementById('cart-body');
          cartBody.innerHTML = '';
          let totalAmount = 0;

          cart.forEach(id => {
              const product = products.find(p => p.id === id);
              if (product) {
                  let quantity = 1; // Default quantity
                  const row = document.createElement('tr');
                  row.innerHTML = `
                      <td class="d-flex align-items-center">
                          <button type="button" class="btn btn-danger btn-sm rounded-circle me-2 remove-item p-0" data-id="${product.id}">
                              <span aria-hidden="true">&times;</span>
                          </button>
                          <img src="${product.image}" alt="${product.name}" width="40" height="40" class="me-2">
                          ${product.name}
                      </td>
                      <td>$${product.price}</td>
                      <td>
                          <div class="input-group input-group-sm w-auto">
                              <button class="btn btn-outline-secondary decrement" type="button">-</button>
                              <input type="text" class="form-control text-center quantity" value="1" style="width: 40px;" data-id="${product.id}">
                              <button class="btn btn-outline-secondary increment" type="button">+</button>
                          </div>
                      </td>
                      <td class="subtotal" data-id="${product.id}">$${product.price}</td>
                  `;
                  cartBody.appendChild(row);
                  totalAmount += product.price;

                  // Set initial quantity from localStorage if exists
                  const cartItems = JSON.parse(localStorage.getItem('cartItems') || '{}');
                  if (cartItems[id]) {
                      quantity = cartItems[id];
                      row.querySelector('.quantity').value = quantity;
                      const subtotal = product.price * quantity;
                      row.querySelector('.subtotal').textContent = `$${subtotal}`;
                      totalAmount += (subtotal - product.price); // Adjust the total
                  }

                  // Quantity controls
                  row.querySelector('.increment').addEventListener('click', function () {
                      quantity++;
                      row.querySelector('.quantity').value = quantity;
                      const subtotal = product.price * quantity;
                      row.querySelector('.subtotal').textContent = `$${subtotal}`;
                      updateCartTotal();
                      saveCartItem(id, quantity);
                  });

                  row.querySelector('.decrement').addEventListener('click', function () {
                      if (quantity > 1) {
                          quantity--;
                          row.querySelector('.quantity').value = quantity;
                          const subtotal = product.price * quantity;
                          row.querySelector('.subtotal').textContent = `$${subtotal}`;
                          updateCartTotal();
                          saveCartItem(id, quantity);
                      }
                  });

                  row.querySelector('.quantity').addEventListener('change', function () {
                      quantity = parseInt(this.value) || 1;
                      if (quantity < 1) quantity = 1;
                      this.value = quantity;
                      const subtotal = product.price * quantity;
                      row.querySelector('.subtotal').textContent = `$${subtotal}`;
                      updateCartTotal();
                      saveCartItem(id, quantity);
                  });
              }
          });

          // Remove item
          cartBody.querySelectorAll('.remove-item').forEach(button => {
              button.addEventListener('click', function () {
                  const productId = parseInt(this.getAttribute('data-id'));
                  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                  const index = cart.indexOf(productId);
                  if (index > -1) {
                      cart.splice(index, 1);
                      localStorage.setItem('cart', JSON.stringify(cart));
                      deleteCartItem(productId);
                      updateCart();
                      updateBadges();
                  }
              });
          });

          updateCartTotal();
      });
  }

  function updateCartTotal() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      loadProducts().then(products => {
          let subtotal = 0;
          cart.forEach(id => {
              const product = products.find(p => p.id === id);
              const cartItems = JSON.parse(localStorage.getItem('cartItems') || '{}');
              const quantity = cartItems[id] || 1;
              subtotal += product.price * quantity;
          });
          document.getElementById('subtotal').textContent = `$${subtotal}`;
          document.getElementById('shipping').textContent = subtotal > 0 ? 'Free' : '$0';
          document.getElementById('total').textContent = `$${subtotal}`;
      });
  }

  function saveCartItem(id, quantity) {
      let cartItems = JSON.parse(localStorage.getItem('cartItems') || '{}');
      cartItems[id] = quantity;
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
  }

  function deleteCartItem(id) {
      let cartItems = JSON.parse(localStorage.getItem('cartItems') || '{}');
      delete cartItems[id];
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
  }

  // Update cart on page load and button click
  document.addEventListener('DOMContentLoaded', updateCart);
  document.getElementById('update-cart').addEventListener('click', updateCart);

  // Apply coupon (basic functionality)
  document.getElementById('apply-coupon').addEventListener('click', function () {
      const couponCode = document.getElementById('coupon-code').value;
      if (couponCode === 'DISCOUNT10') {
          let total = parseFloat(document.getElementById('total').textContent.replace('$', ''));
          total *= 0.9; // 10% discount
          document.getElementById('total').textContent = `$${total.toFixed(0)}`;
          alert('Coupon applied! 10% discount added.');
      } else {
          alert('Invalid coupon code.');
      }
  });
</script>
</body>
</html>