<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
    <div class="container mt-5">
        <form id="myForm">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" value="emilys" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" value="emilyspass" required>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe">
                <label class="form-check-label" for="rememberMe">Remember me</label>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
    </div>

    <script>
        const myForm = document.getElementById('myForm');

        myForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            // Log the request payload
            console.log('Sending login request with:', { username, password });

            // Step 1: Attempt to login using XMLHttpRequest
            const loginXhr = new XMLHttpRequest();
            loginXhr.open('POST', 'https://dummyjson.com/auth/login', true);
            loginXhr.setRequestHeader('Content-Type', 'application/json');

            loginXhr.onreadystatechange = function () {
                if (loginXhr.readyState === XMLHttpRequest.DONE) {
                    console.log('Login response status:', loginXhr.status);
                    try {
                        const data = JSON.parse(loginXhr.responseText);
                        if (loginXhr.status === 200 && data.accessToken) {
                            // Step 2: Fetch user profile using XMLHttpRequest
                            const profileXhr = new XMLHttpRequest();
                            profileXhr.open('GET', 'https://dummyjson.com/auth/me', true);
                            profileXhr.setRequestHeader('Authorization', `Bearer ${data.accessToken}`);

                            profileXhr.onreadystatechange = function () {
                                if (profileXhr.readyState === XMLHttpRequest.DONE) {
                                    console.log('Profile response status:', profileXhr.status);
                                    try {
                                        const profileData = JSON.parse(profileXhr.responseText);
                                        if (profileXhr.status === 200) {
                                            console.log('User Profile:', profileData);
                                            alert('Logged in successfully! Check console for profile details.');
                                        } else {
                                            throw new Error(profileData.message || 'Failed to fetch profile');
                                        }
                                    } catch (error) {
                                        console.error('Error:', error.message);
                                        alert(`An error occurred: ${error.message}`);
                                        console.log('Try alternative credentials: username: michaelw, password: michaelwpass');
                                    }
                                }
                            };

                            profileXhr.send();
                        } else {
                            throw new Error(data.message || 'Invalid response from server');
                        }
                    } catch (error) {
                        console.error('Error:', error.message);
                        alert(`An error occurred: ${error.message}`);
                        console.log('Try alternative credentials: username: michaelw, password: michaelwpass');
                    }
                }
            };

            loginXhr.send(JSON.stringify({
                username: username,
                password: password,
                expiresInMins: 30
            }));
        });
    </script>
</body>
</html>